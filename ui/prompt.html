<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>任务输入</title>
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        padding: 8px;
        background: transparent;
        overflow: hidden;
        font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      }
      .shell {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
      }
      .pill {
        position: relative;
        display: flex;
        align-items: center;
        gap: 6px;
        height: 50px;
        width: 100%;
        padding: 5px 6px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid #d9d9dd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        isolation: isolate;
        overflow: visible;
      }
      .pill::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background:
          radial-gradient(58% 130% at 0% 50%, rgba(68, 232, 255, 0.26), transparent 70%),
          radial-gradient(58% 130% at 100% 50%, rgba(124, 171, 255, 0.24), transparent 70%),
          radial-gradient(120% 92% at 50% 0%, rgba(101, 255, 178, 0.2), transparent 68%),
          radial-gradient(120% 92% at 50% 100%, rgba(255, 154, 172, 0.18), transparent 68%);
        filter: blur(7px) saturate(1.06);
        opacity: 0.95;
        z-index: 0;
        pointer-events: none;
      }
      .pill > * {
        position: relative;
        z-index: 1;
      }
      #taskInput {
        flex: 1;
        min-width: 0;
        height: 100%;
        border: 0;
        outline: none;
        background: transparent;
        color: #1f2937;
        font-size: 16px;
      }
      #taskInput::placeholder {
        color: #9ca3af;
      }
      .model-picker {
        position: relative;
        flex: 0 0 auto;
      }
      #modelTargetBtn {
        height: 34px;
        width: 132px;
        border: 1px solid #e4e4e7;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.92);
        color: #111827;
        font-size: 12px;
        font-weight: 500;
        padding: 0 9px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
      }
      #modelTargetBtn:hover {
        border-color: #d4d4d8;
        background: #ffffff;
      }
      #modelTargetBtn .label {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #modelTargetBtn .caret {
        font-size: 10px;
        color: #374151;
        margin-left: 6px;
      }
      #modelTargetMenu {
        position: absolute;
        right: 0;
        bottom: calc(100% + 8px);
        width: 260px;
        max-height: 260px;
        overflow: auto;
        border: 1px solid #d4d4d8;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18);
        padding: 6px;
        display: none;
        z-index: 20;
      }
      #modelTargetMenu.open {
        display: block;
      }
      .model-item {
        width: 100%;
        border: 0;
        border-radius: 8px;
        background: transparent;
        color: #111827;
        font-size: 12px;
        text-align: left;
        padding: 7px 9px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .model-item:hover {
        background: #eef2f7;
      }
      .model-item.active {
        background: #e0edff;
        color: #0f3c8a;
      }
      #closeBtn {
        flex: 0 0 auto;
        width: 34px;
        height: 34px;
        border: 0;
        border-radius: 999px;
        background: #f4f4f5;
        color: #27272a;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 21px;
        line-height: 1;
      }
      #closeBtn:hover {
        background: #e4e4e7;
      }
      #runBtn {
        flex: 0 0 auto;
        width: 34px;
        height: 34px;
        border: 0;
        border-radius: 999px;
        background: #09090b;
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #runBtn svg {
        width: 15px;
        height: 15px;
        display: block;
      }
      #runBtn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }
      #status {
        display: none;
      }
      .warn {
        color: #8a6a00;
      }
      .error {
        color: #b3261e;
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <div class="pill">
        <button id="closeBtn" aria-label="关闭">×</button>
        <input id="taskInput" type="text" placeholder="输入需要完成的任务……" />
        <div class="model-picker" id="modelPicker">
          <button id="modelTargetBtn" aria-label="选择模型">
            <span class="label" id="modelTargetLabel">所有已启用模型</span>
            <span class="caret">▼</span>
          </button>
          <div id="modelTargetMenu"></div>
        </div>
        <button id="runBtn" aria-label="执行">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 19V5"></path>
            <path d="M6 11l6-6 6 6"></path>
          </svg>
        </button>
      </div>
      <div id="status">待命</div>
    </main>

    <script>
      const taskInput = document.getElementById('taskInput');
      const closeBtn = document.getElementById('closeBtn');
      const modelPickerEl = document.getElementById('modelPicker');
      const modelTargetBtn = document.getElementById('modelTargetBtn');
      const modelTargetLabelEl = document.getElementById('modelTargetLabel');
      const modelTargetMenuEl = document.getElementById('modelTargetMenu');
      const runBtn = document.getElementById('runBtn');
      const statusEl = document.getElementById('status');
      const bridge = window.autogui;
      let running = false;
      let selectedModelTarget = 'all';
      let modelTargets = [{ id: 'all', label: '所有已启用模型' }];
      let clickThroughEnabled = false;

      function setStatus(text, type = '') {
        statusEl.textContent = text;
        statusEl.className = type;
      }

      function renderModelTargetMenu() {
        modelTargetMenuEl.innerHTML = '';
        modelTargets.forEach((item) => {
          const btn = document.createElement('button');
          btn.className = `model-item${selectedModelTarget === item.id ? ' active' : ''}`;
          btn.textContent = item.label;
          btn.type = 'button';
          btn.addEventListener('click', () => {
            selectedModelTarget = item.id;
            modelTargetLabelEl.textContent = item.label;
            modelTargetMenuEl.classList.remove('open');
            renderModelTargetMenu();
          });
          modelTargetMenuEl.appendChild(btn);
        });
      }

      async function refreshModelTargets() {
        try {
          const res = await bridge.listModelTargets();
          const current = selectedModelTarget || 'all';
          modelTargets = [{ id: 'all', label: '所有已启用模型' }];
          if (res.ok && Array.isArray(res.targets)) {
            res.targets.forEach((t) => {
              modelTargets.push({ id: t.id, label: t.label });
            });
          }
          const currentExists = modelTargets.some((x) => x.id === current);
          selectedModelTarget = currentExists ? current : 'all';
          const selected = modelTargets.find((x) => x.id === selectedModelTarget);
          modelTargetLabelEl.textContent = selected ? selected.label : '所有已启用模型';
          renderModelTargetMenu();
        } catch {
          // ignore model target load errors
        }
      }

      function isPointInsideRect(x, y, rect) {
        return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
      }

      async function setClickThrough(enabled) {
        if (clickThroughEnabled === enabled) return;
        clickThroughEnabled = enabled;
        try {
          await bridge.setPromptClickThrough(enabled);
        } catch {
          // ignore click-through toggle errors
        }
      }

      function updateClickThroughByPointer(clientX, clientY) {
        const shellRect = document.querySelector('.shell').getBoundingClientRect();
        const inShell = isPointInsideRect(clientX, clientY, shellRect);
        const menuOpen = modelTargetMenuEl.classList.contains('open');
        const menuRect = menuOpen ? modelTargetMenuEl.getBoundingClientRect() : null;
        const inMenu = menuRect ? isPointInsideRect(clientX, clientY, menuRect) : false;
        void setClickThrough(!(inShell || inMenu));
      }

      async function submitTask() {
        const task = (taskInput.value || '').trim();
        if (!task) {
          setStatus('任务不能为空', 'warn');
          return;
        }

        try {
          const res = await bridge.submitTask({
            task,
            modelTarget: selectedModelTarget || 'all',
          });
          if (!res.ok) {
            setStatus(res.message || '启动失败', 'error');
          }
        } catch (error) {
          setStatus(error instanceof Error ? error.message : String(error), 'error');
        }
      }

      closeBtn.addEventListener('click', () => {
        void bridge.hidePrompt();
      });
      document.querySelector('.shell').addEventListener('mouseenter', () => {
        void setClickThrough(false);
      });

      runBtn.addEventListener('click', () => {
        void submitTask();
      });
      modelTargetBtn.addEventListener('click', (event) => {
        event.preventDefault();
        modelTargetMenuEl.classList.toggle('open');
      });
      window.addEventListener('click', (event) => {
        if (!modelPickerEl.contains(event.target)) {
          modelTargetMenuEl.classList.remove('open');
        }
      });
      window.addEventListener('mousemove', (event) => {
        updateClickThroughByPointer(event.clientX, event.clientY);
      });
      window.addEventListener('mousedown', (event) => {
        updateClickThroughByPointer(event.clientX, event.clientY);
      });

      taskInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          void submitTask();
        }

        if (event.key === 'Escape') {
          event.preventDefault();
          void bridge.hidePrompt();
        }
      });

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          void bridge.hidePrompt();
        }
      });

      bridge.onPromptReset(() => {
        taskInput.value = '';
        void refreshModelTargets();
        setStatus(running ? '任务执行中' : '待命');
        void setClickThrough(true);
        taskInput.focus();
      });

      bridge.onStatus(({ status, detail }) => {
        running = status === 'running';
        runBtn.disabled = running;
        if (status === 'error') {
          setStatus(detail || '任务错误', 'error');
          return;
        }
        setStatus(detail || (running ? '任务执行中' : '待命'));
      });

      taskInput.focus();
      void setClickThrough(true);
      void refreshModelTargets();
    </script>
  </body>
</html>
